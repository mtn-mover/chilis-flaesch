<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artikel erstellen - Fl√§sch Info Admin</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            text-decoration: none;
            color: white;
        }

        .header-logo img {
            height: 50px;
            width: auto;
        }

        .header-logo h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header-logo:hover {
            opacity: 0.9;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel h2 {
            margin-bottom: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .preview-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 2rem;
            min-height: 400px;
            background: #fafafa;
        }

        .preview-area.has-content {
            border: 1px solid #ddd;
            background: white;
        }

        .preview-placeholder {
            text-align: center;
            color: #999;
            padding: 3rem 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .uploaded-images {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .uploaded-image {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 5px;
            overflow: hidden;
        }

        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        /* Editor Modal */
        .editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .editor-modal.active {
            display: flex;
        }

        .editor-content {
            background: white;
            border-radius: 10px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            padding: 1.5rem;
            border-bottom: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-header h3 {
            margin: 0;
            color: #333;
        }

        .editor-body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .editor-textarea {
            width: 100%;
            min-height: 500px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Rich Text Editor */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            flex-wrap: wrap;
        }

        .editor-toolbar button {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            min-width: 35px;
        }

        .editor-toolbar button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .editor-toolbar button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .editor-toolbar select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
        }

        .rich-editor {
            width: 100%;
            min-height: 500px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.05rem;
            line-height: 1.6;
            overflow-y: auto;
            background: white;
        }

        .rich-editor:focus {
            outline: none;
        }

        .editor-mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .editor-footer {
            padding: 1.5rem;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .status-message {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 968px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="header-logo">
                <img src="logo.png" alt="Fl√§sch Info Logo">
                <h1>Artikel erstellen</h1>
            </a>
            <div class="nav-links" id="navLinks">
                <a href="my-articles.html">Meine Artikel</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div class="two-column">
            <!-- Left: Input Form -->
            <div class="panel">
                <h2>Artikel-Details</h2>
                <form id="articleForm">
                    <div class="form-group">
                        <label for="title">Titel *</label>
                        <input type="text" id="title" name="title" required
                               placeholder="z.B. Dorfplatz-Umbau sorgt f√ºr Chaos">
                    </div>

                    <div class="form-group">
                        <label for="subtitle">Untertitel / Schlagzeile</label>
                        <input type="text" id="subtitle" name="subtitle"
                               placeholder="Wird automatisch von Claude generiert, kann aber bearbeitet werden"
                               maxlength="150">
                        <small style="color: #666; font-size: 0.85rem;">Max. 150 Zeichen - wird nach Generierung automatisch bef√ºllt</small>
                    </div>

                    <div class="form-group">
                        <label for="category">Kategorie *</label>
                        <select id="category" name="category" required>
                            <option value="politik">Politik</option>
                            <option value="wirtschaft">Wirtschaft</option>
                            <option value="kurioses" selected>Kurioses</option>
                            <option value="gesellschaft">Gesellschaft</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="style">Stil</label>
                        <select id="style" name="style">
                            <option value="satirisch" selected>Satirisch</option>
                            <option value="absurd">Absurd</option>
                            <option value="ironisch">Ironisch</option>
                            <option value="ernst-satirisch">Ernst-Satirisch</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="content">Beschreibung / Details *</label>
                        <textarea id="content" name="content" required
                                  placeholder="Beschreibe die Geschichte, wichtige Details, Personen (nur Vornamen!), etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Hintergrundinformationen hochladen (optional)</label>
                        <div class="image-upload" id="infoUpload">
                            <input type="file" id="infoInput" accept=".pdf,.txt,.doc,.docx,image/*" multiple style="display: none;">
                            <p>Klicken zum Hochladen oder Drag & Drop</p>
                            <small>PDF, Bilder, Textdokumente (max 10MB pro Datei)</small>
                            <small style="display: block; margin-top: 0.5rem; color: #666;">Diese Dateien werden NUR zur Information f√ºr Claude verwendet, nicht ver√∂ffentlicht</small>
                        </div>
                        <div class="uploaded-images" id="uploadedInfo"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">Mit Claude generieren</button>
                </form>
            </div>

            <!-- Right: Preview -->
            <div class="panel">
                <h2>Vorschau</h2>
                <div id="previewArea" class="preview-area">
                    <div class="preview-placeholder">
                        <p>Artikel-Vorschau erscheint hier nach dem Generieren</p>
                    </div>
                </div>

                <!-- Image upload after generation -->
                <div id="postGenerationImageUpload" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #eee;">
                    <div class="form-group">
                        <label>Bilder zum Artikel hinzuf√ºgen</label>
                        <div class="image-upload" id="postImageUpload">
                            <input type="file" id="postImageInput" accept="image/*" multiple style="display: none;">
                            <p>Klicken zum Hochladen oder Drag & Drop</p>
                            <small>JPG, PNG, GIF, WebP (max 5MB pro Bild)</small>
                        </div>
                        <div class="uploaded-images" id="postUploadedImages"></div>
                    </div>
                </div>

                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button class="btn btn-secondary" onclick="regenerateArticle()">Neu generieren</button>
                    <button class="btn btn-primary" onclick="openEditor()">‚úèÔ∏è Text bearbeiten</button>
                    <button class="btn btn-success" onclick="saveDraft()">Als Draft speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div class="editor-modal" id="editorModal">
        <div class="editor-content">
            <div class="editor-header">
                <h3>‚úèÔ∏è Artikel bearbeiten</h3>
                <div class="editor-mode-toggle">
                    <button class="mode-btn active" onclick="switchEditorMode('visual')" id="visualModeBtn">üìù Visuell</button>
                    <button class="mode-btn" onclick="switchEditorMode('html')" id="htmlModeBtn">‚å®Ô∏è HTML</button>
                </div>
            </div>
            <div class="editor-body">
                <!-- Title Input -->
                <div style="margin-bottom: 1rem;">
                    <label for="editorTitle" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333;">Titel:</label>
                    <input type="text" id="editorTitle" style="width: 100%; padding: 0.75rem; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 5px;" placeholder="Artikel-Titel">
                </div>

                <!-- Subtitle Input -->
                <div style="margin-bottom: 1rem;">
                    <label for="editorSubtitle" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333;">Untertitel / Schlagzeile:</label>
                    <input type="text" id="editorSubtitle" style="width: 100%; padding: 0.75rem; font-size: 1rem; border: 2px solid #ddd; border-radius: 5px;" placeholder="Kurze, knackige Schlagzeile" maxlength="150">
                    <small style="color: #666; font-size: 0.85rem;">Max. 150 Zeichen</small>
                </div>

                <!-- Visual Editor -->
                <div id="visualEditorContainer" style="display: block;">
                    <div class="editor-toolbar">
                        <button onclick="formatText('bold')" title="Fett"><b>B</b></button>
                        <button onclick="formatText('italic')" title="Kursiv"><i>I</i></button>
                        <button onclick="formatText('underline')" title="Unterstrichen"><u>U</u></button>
                        <button onclick="formatText('strikeThrough')" title="Durchgestrichen"><s>S</s></button>
                        <span style="border-left: 1px solid #ddd; height: 30px;"></span>
                        <select onchange="formatBlock(this.value)" title="√úberschrift">
                            <option value="">Normal</option>
                            <option value="h2">√úberschrift 2</option>
                            <option value="h3">√úberschrift 3</option>
                        </select>
                        <span style="border-left: 1px solid #ddd; height: 30px;"></span>
                        <button onclick="formatText('insertUnorderedList')" title="Liste">‚Ä¢ Liste</button>
                        <button onclick="formatText('insertOrderedList')" title="Nummerierte Liste">1. Liste</button>
                        <span style="border-left: 1px solid #ddd; height: 30px;"></span>
                        <button onclick="formatText('justifyLeft')" title="Links">‚¨Ö</button>
                        <button onclick="formatText('justifyCenter')" title="Zentriert">‚Üî</button>
                        <button onclick="formatText('justifyRight')" title="Rechts">‚û°</button>
                    </div>
                    <div id="richEditor" class="rich-editor" contenteditable="true"></div>
                </div>

                <!-- HTML Editor -->
                <div id="htmlEditorContainer" style="display: none;">
                    <textarea id="editorTextarea" class="editor-textarea" placeholder="HTML-Inhalt hier bearbeiten..."></textarea>
                </div>
            </div>
            <div class="editor-footer">
                <button class="btn btn-secondary" onclick="closeEditor()">Abbrechen</button>
                <button class="btn btn-success" onclick="saveEditorChanges()">√Ñnderungen √ºbernehmen</button>
            </div>
        </div>
    </div>

    <script>
        let currentDraft = null;
        let uploadedImages = [];
        let uploadedInfoFiles = [];

        // Auth Check
        const sessionToken = localStorage.getItem('sessionToken');
        if (!sessionToken) {
            window.location.href = 'admin.html';
        }

        // Logout
        function logout() {
            if (window.authUtils) {
                window.authUtils.logout();
            } else {
                // Cookie Consent behalten
                const cookieConsent = localStorage.getItem('flaesch_cookie_consent');
                localStorage.clear();
                if (cookieConsent) {
                    localStorage.setItem('flaesch_cookie_consent', cookieConsent);
                }
                window.location.href = 'admin.html';
            }
        }

        // Check if editing existing draft
        const urlParams = new URLSearchParams(window.location.search);
        const editDraftId = urlParams.get('edit');
        let currentEditingDraftId = null;

        // Load draft for editing if ID provided
        if (editDraftId) {
            loadDraftForEditing(editDraftId);
        }

        async function loadDraftForEditing(draftId) {
            try {
                const response = await fetch('/api/get-drafts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken })
                });

                const result = await response.json();
                if (response.ok) {
                    const draft = result.drafts.find(d => d.id === draftId);
                    if (draft) {
                        currentEditingDraftId = draftId;

                        // Fill form fields
                        document.getElementById('title').value = draft.title || '';
                        document.getElementById('subtitle').value = draft.subtitle || '';
                        document.getElementById('category').value = draft.category || 'politik';
                        document.getElementById('style').value = draft.style || 'satirisch';
                        document.getElementById('content').value = draft.content || '';

                        // Update header to show we're editing
                        document.querySelector('.header h1').textContent = 'Artikel bearbeiten';

                        // Show preview if available
                        if (draft.html) {
                            currentDraft = draft;
                            const previewArea = document.getElementById('previewArea');
                            const actionButtons = document.getElementById('actionButtons');

                            // Show preview with subtitle
                            let previewHTML = '';
                            if (draft.subtitle) {
                                previewHTML = `<p style="font-size: 1.1rem; color: #666; font-style: italic; margin-bottom: 1.5rem; border-left: 4px solid #667eea; padding-left: 1rem;">${draft.subtitle}</p>`;
                            }
                            previewHTML += draft.html;

                            previewArea.innerHTML = previewHTML;
                            previewArea.classList.add('has-content');
                            actionButtons.style.display = 'flex';

                            // Show post-generation image upload when editing
                            document.getElementById('postGenerationImageUpload').style.display = 'block';
                        }

                        // Load images if available
                        if (draft.images && draft.images.length > 0) {
                            uploadedImages = draft.images;
                            draft.images.forEach(url => displayPostUploadedImage(url));
                        }
                    } else {
                        alert('Draft nicht gefunden');
                        window.location.href = 'my-articles.html';
                    }
                } else {
                    alert('Fehler beim Laden: ' + result.error);
                }
            } catch (error) {
                alert('Fehler beim Laden: ' + error.message);
            }
        }

        // Info Upload (PDFs, docs, etc.)
        const infoUpload = document.getElementById('infoUpload');
        const infoInput = document.getElementById('infoInput');
        const uploadedInfoDiv = document.getElementById('uploadedInfo');

        infoUpload.addEventListener('click', () => infoInput.click());

        infoInput.addEventListener('change', async function(e) {
            const files = e.target.files;
            for (let file of files) {
                await uploadInfoFile(file);
            }
        });

        async function uploadInfoFile(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    // For PDFs and docs, we'll just store reference for now
                    // Later can add OCR or text extraction
                    uploadedInfoFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });

                    displayUploadedInfoFile(file.name, file.type);
                } catch (error) {
                    alert('Fehler beim Hochladen: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        function displayUploadedInfoFile(name, type) {
            const div = document.createElement('div');
            div.className = 'uploaded-image';
            const icon = type.includes('pdf') ? 'üìÑ' : type.includes('image') ? 'üñºÔ∏è' : 'üìù';
            div.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; padding: 1rem; font-size: 2rem;">
                    ${icon}
                </div>
                <button class="image-remove" onclick="removeInfoFile('${name}')">√ó</button>
                <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem; font-size: 0.7rem; text-align: center; border-radius: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</div>
            `;
            uploadedInfoDiv.appendChild(div);
        }

        function removeInfoFile(name) {
            uploadedInfoFiles = uploadedInfoFiles.filter(f => f.name !== name);
            const items = uploadedInfoDiv.querySelectorAll('.uploaded-image');
            items.forEach(item => {
                if (item.textContent.includes(name)) {
                    item.remove();
                }
            });
        }

        // Post-Generation Image Upload (main image upload - only after article generation)
        const postImageUpload = document.getElementById('postImageUpload');
        const postImageInput = document.getElementById('postImageInput');
        const postUploadedImagesDiv = document.getElementById('postUploadedImages');

        postImageUpload.addEventListener('click', () => postImageInput.click());

        postImageInput.addEventListener('change', async function(e) {
            const files = e.target.files;
            for (let file of files) {
                await uploadPostImage(file);
            }
            // Reset input so same file can be uploaded again
            e.target.value = '';
        });

        async function uploadPostImage(file) {
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'uploaded-image';
            loadingDiv.innerHTML = `
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Hochladen...</p>
            `;
            postUploadedImagesDiv.appendChild(loadingDiv);

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionToken: sessionToken,
                            imageData: e.target.result,
                            fileName: file.name,
                            articleSlug: document.getElementById('title').value
                        })
                    });

                    const result = await response.json();

                    // Remove loading indicator
                    loadingDiv.remove();

                    if (result.success) {
                        uploadedImages.push(result.imageUrl);
                        displayPostUploadedImage(result.imageUrl);

                        // Update currentDraft images
                        if (currentDraft) {
                            currentDraft.images = uploadedImages;
                        }
                    } else {
                        alert('Fehler beim Hochladen: ' + result.error);
                    }
                } catch (error) {
                    // Remove loading indicator on error
                    loadingDiv.remove();
                    alert('Fehler beim Hochladen: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        function displayPostUploadedImage(url) {
            const div = document.createElement('div');
            div.className = 'uploaded-image';
            div.innerHTML = `
                <img src="${url}" alt="Uploaded">
                <button class="image-remove" onclick="removePostImage('${url}')">√ó</button>
            `;
            postUploadedImagesDiv.appendChild(div);
        }

        // Make removePostImage globally accessible
        window.removePostImage = function(url) {
            uploadedImages = uploadedImages.filter(img => img !== url);
            const imgs = postUploadedImagesDiv.querySelectorAll('.uploaded-image');
            imgs.forEach(img => {
                if (img.querySelector('img').src === url) {
                    img.remove();
                }
            });

            // Update currentDraft images
            if (currentDraft) {
                currentDraft.images = uploadedImages;
            }
        }

        // Form Submit - Generate Article
        document.getElementById('articleForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const previewArea = document.getElementById('previewArea');
            const actionButtons = document.getElementById('actionButtons');
            const statusMessage = document.getElementById('statusMessage');

            // Show loading
            previewArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>Claude generiert Artikel...</p></div>';
            previewArea.classList.remove('has-content');
            actionButtons.style.display = 'none';
            statusMessage.style.display = 'none';

            const formData = new FormData(this);

            // Add info files to content description
            let contentWithInfo = formData.get('content');
            if (uploadedInfoFiles.length > 0) {
                contentWithInfo += '\n\nHINTERGRUNDINFORMATIONEN:\n';
                contentWithInfo += uploadedInfoFiles.map(f => `- Datei: ${f.name} (${f.type})`).join('\n');
                contentWithInfo += '\n\nDiese Dateien enthalten zus√§tzliche Informationen f√ºr den Artikel. Nutze relevante Details daraus.';
            }

            const payload = {
                sessionToken: sessionToken,
                title: formData.get('title'),
                category: formData.get('category'),
                style: formData.get('style'),
                content: contentWithInfo,
                author: localStorage.getItem('username'),
                infoFiles: uploadedInfoFiles,
                images: uploadedImages
            };

            try {
                const response = await fetch('/api/create-article', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server-Fehler (${response.status}): ${text.substring(0, 200)}`);
                }

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'Unbekannter Fehler');
                }

                // Fill subtitle field if generated
                if (result.subtitle) {
                    document.getElementById('subtitle').value = result.subtitle;
                }

                // Store current draft
                currentDraft = {
                    title: payload.title,
                    subtitle: result.subtitle || '',
                    category: payload.category,
                    style: payload.style,
                    content: payload.content,
                    html: result.html,
                    fileName: result.fileName,
                    images: uploadedImages
                };

                // Show preview with subtitle
                let previewHTML = '';
                if (result.subtitle) {
                    previewHTML = `<p style="font-size: 1.1rem; color: #666; font-style: italic; margin-bottom: 1.5rem; border-left: 4px solid #667eea; padding-left: 1rem;">${result.subtitle}</p>`;
                }
                previewHTML += result.html;

                previewArea.innerHTML = previewHTML;
                previewArea.classList.add('has-content');
                actionButtons.style.display = 'flex';

                // Show post-generation image upload
                document.getElementById('postGenerationImageUpload').style.display = 'block';

                statusMessage.className = 'status-message status-success';
                statusMessage.textContent = '‚úÖ Artikel erfolgreich generiert!';
                statusMessage.style.display = 'block';

            } catch (error) {
                previewArea.innerHTML = `<div class="preview-placeholder"><p style="color: red;">‚ùå Fehler: ${error.message}</p></div>`;
                statusMessage.className = 'status-message status-error';
                statusMessage.textContent = '‚ùå Fehler: ' + error.message;
                statusMessage.style.display = 'block';
            }
        });

        // Regenerate Article
        async function regenerateArticle() {
            const changes = prompt('Was soll anders sein? (z.B. "lustiger", "weniger √ºbertrieben", "mehr Details √ºber...")');
            if (!changes) return;

            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>Claude generiert neu...</p></div>';

            const payload = {
                sessionToken: sessionToken,
                title: currentDraft.title,
                category: currentDraft.category,
                style: currentDraft.style,
                content: currentDraft.content + '\n\n√ÑNDERUNGSW√úNSCHE: ' + changes,
                author: sessionStorage.getItem('username')
            };

            try {
                const response = await fetch('/api/create-article', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (response.ok) {
                    currentDraft.html = result.html;
                    previewArea.innerHTML = result.html;
                } else {
                    alert('Fehler: ' + result.error);
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        // Subtitle input change handler - update preview
        document.getElementById('subtitle').addEventListener('input', function() {
            if (currentDraft) {
                const subtitle = this.value.trim();
                currentDraft.subtitle = subtitle;

                // Update preview
                const previewArea = document.getElementById('previewArea');
                let previewHTML = '';
                if (subtitle) {
                    previewHTML = `<p style="font-size: 1.1rem; color: #666; font-style: italic; margin-bottom: 1.5rem; border-left: 4px solid #667eea; padding-left: 1rem;">${subtitle}</p>`;
                }
                previewHTML += currentDraft.html;
                previewArea.innerHTML = previewHTML;
            }
        });

        // Save Draft
        async function saveDraft() {
            if (!currentDraft) {
                alert('Kein Artikel zum Speichern vorhanden');
                return;
            }

            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = 'Speichere...';
            statusMessage.className = 'status-message status-success';
            statusMessage.style.display = 'block';

            try {
                // Get current subtitle from form field
                const subtitle = document.getElementById('subtitle').value.trim();
                currentDraft.subtitle = subtitle;

                // If editing, include the draft ID to update it
                const draftPayload = currentEditingDraftId
                    ? { ...currentDraft, id: currentEditingDraftId }
                    : currentDraft;

                const response = await fetch('/api/save-draft', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionToken: sessionToken,
                        draft: draftPayload
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    statusMessage.textContent = '‚úÖ Draft gespeichert! Du findest ihn unter "Meine Artikel"';
                    setTimeout(() => {
                        window.location.href = 'my-articles.html';
                    }, 1500);
                } else {
                    throw new Error(result.error + (result.details ? '\n\nDetails: ' + result.details : '') + (result.stack ? '\n\nStack: ' + result.stack : ''));
                }
            } catch (error) {
                statusMessage.className = 'status-message status-error';
                statusMessage.innerHTML = '<pre style="white-space: pre-wrap; text-align: left; font-size: 0.85rem;">‚ùå Fehler: ' + error.message + '</pre>';
                console.error('Full error:', error);
            }
        }

        // Editor Functions
        let currentEditorMode = 'visual';

        function openEditor() {
            if (!currentDraft || !currentDraft.html) {
                alert('Kein Artikel zum Bearbeiten vorhanden');
                return;
            }

            const modal = document.getElementById('editorModal');
            const richEditor = document.getElementById('richEditor');
            const textarea = document.getElementById('editorTextarea');
            const titleInput = document.getElementById('editorTitle');
            const subtitleInput = document.getElementById('editorSubtitle');

            // Fill title and subtitle fields
            titleInput.value = currentDraft.title || '';
            subtitleInput.value = currentDraft.subtitle || '';

            // Fill both editors with current HTML
            richEditor.innerHTML = currentDraft.html;
            textarea.value = currentDraft.html;

            // Show modal in visual mode
            switchEditorMode('visual');
            modal.classList.add('active');
        }

        function closeEditor() {
            const modal = document.getElementById('editorModal');
            modal.classList.remove('active');
        }

        function switchEditorMode(mode) {
            currentEditorMode = mode;
            const visualContainer = document.getElementById('visualEditorContainer');
            const htmlContainer = document.getElementById('htmlEditorContainer');
            const visualBtn = document.getElementById('visualModeBtn');
            const htmlBtn = document.getElementById('htmlModeBtn');
            const richEditor = document.getElementById('richEditor');
            const textarea = document.getElementById('editorTextarea');

            if (mode === 'visual') {
                // Switch to visual mode
                visualContainer.style.display = 'block';
                htmlContainer.style.display = 'none';
                visualBtn.classList.add('active');
                htmlBtn.classList.remove('active');

                // Sync HTML to visual editor
                richEditor.innerHTML = textarea.value;
            } else {
                // Switch to HTML mode
                visualContainer.style.display = 'none';
                htmlContainer.style.display = 'block';
                visualBtn.classList.remove('active');
                htmlBtn.classList.add('active');

                // Sync visual editor to HTML
                textarea.value = richEditor.innerHTML;
            }
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('richEditor').focus();
        }

        function formatBlock(tag) {
            if (tag) {
                document.execCommand('formatBlock', false, tag);
            }
            document.getElementById('richEditor').focus();
        }

        function saveEditorChanges() {
            const richEditor = document.getElementById('richEditor');
            const textarea = document.getElementById('editorTextarea');
            const titleInput = document.getElementById('editorTitle');
            const subtitleInput = document.getElementById('editorSubtitle');

            // Get title
            const newTitle = titleInput.value.trim();
            if (!newTitle) {
                alert('Der Titel darf nicht leer sein');
                return;
            }

            // Get subtitle
            const newSubtitle = subtitleInput.value.trim();

            // Get HTML from current mode
            let newHTML;
            if (currentEditorMode === 'visual') {
                newHTML = richEditor.innerHTML;
            } else {
                newHTML = textarea.value;
            }

            if (!newHTML.trim()) {
                alert('Der Artikel-Inhalt darf nicht leer sein');
                return;
            }

            // Update current draft with new title, subtitle and HTML
            currentDraft.title = newTitle;
            currentDraft.subtitle = newSubtitle;
            currentDraft.html = newHTML;

            // Update the form title and subtitle fields as well
            document.getElementById('title').value = newTitle;
            document.getElementById('subtitle').value = newSubtitle;

            // Update preview with subtitle
            const previewArea = document.getElementById('previewArea');
            let previewHTML = '';
            if (newSubtitle) {
                previewHTML = `<p style="font-size: 1.1rem; color: #666; font-style: italic; margin-bottom: 1.5rem; border-left: 4px solid #667eea; padding-left: 1rem;">${newSubtitle}</p>`;
            }
            previewHTML += newHTML;
            previewArea.innerHTML = previewHTML;

            // Close modal
            closeEditor();

            // Show success message
            alert('‚úÖ √Ñnderungen wurden √ºbernommen! Du kannst jetzt den Draft speichern.');
        }

        // Check if user is admin and add admin link
        async function checkAdminRole() {
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken })
                });

                const result = await response.json();
                if (result.valid && result.role === 'admin') {
                    const navLinks = document.getElementById('navLinks');
                    // Check if admin link already exists
                    const existingAdminLink = navLinks.querySelector('a[href="admin-users.html"]');
                    if (!existingAdminLink) {
                        const adminLink = document.createElement('a');
                        adminLink.href = 'admin-users.html';
                        adminLink.textContent = 'üë• Benutzerverwaltung';
                        // Insert before logout link
                        navLinks.insertBefore(adminLink, navLinks.lastElementChild);
                    }
                }
            } catch (error) {
                console.error('Failed to check admin role:', error);
            }
        }

        // Initialize admin link check
        checkAdminRole();
    </script>
</body>
</html>
