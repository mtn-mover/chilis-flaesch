<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artikel erstellen - Fl√§sch Info Admin</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel h2 {
            margin-bottom: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .preview-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 2rem;
            min-height: 400px;
            background: #fafafa;
        }

        .preview-area.has-content {
            border: 1px solid #ddd;
            background: white;
        }

        .preview-placeholder {
            text-align: center;
            color: #999;
            padding: 3rem 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .uploaded-images {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .uploaded-image {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 5px;
            overflow: hidden;
        }

        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .status-message {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 968px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Artikel erstellen</h1>
            <div class="nav-links" id="navLinks">
                <a href="my-articles.html">Meine Artikel</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div class="two-column">
            <!-- Left: Input Form -->
            <div class="panel">
                <h2>Artikel-Details</h2>
                <form id="articleForm">
                    <div class="form-group">
                        <label for="title">Titel *</label>
                        <input type="text" id="title" name="title" required
                               placeholder="z.B. Dorfplatz-Umbau sorgt f√ºr Chaos">
                    </div>

                    <div class="form-group">
                        <label for="category">Kategorie *</label>
                        <select id="category" name="category" required>
                            <option value="politik">Politik</option>
                            <option value="wirtschaft">Wirtschaft</option>
                            <option value="kurioses" selected>Kurioses</option>
                            <option value="gesellschaft">Gesellschaft</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="style">Stil</label>
                        <select id="style" name="style">
                            <option value="satirisch" selected>Satirisch</option>
                            <option value="absurd">Absurd</option>
                            <option value="ironisch">Ironisch</option>
                            <option value="ernst-satirisch">Ernst-Satirisch</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="content">Beschreibung / Details *</label>
                        <textarea id="content" name="content" required
                                  placeholder="Beschreibe die Geschichte, wichtige Details, Personen (nur Vornamen!), etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Hintergrundinformationen hochladen (optional)</label>
                        <div class="image-upload" id="infoUpload">
                            <input type="file" id="infoInput" accept=".pdf,.txt,.doc,.docx,image/*" multiple style="display: none;">
                            <p>Klicken zum Hochladen oder Drag & Drop</p>
                            <small>PDF, Bilder, Textdokumente (max 10MB pro Datei)</small>
                            <small style="display: block; margin-top: 0.5rem; color: #666;">Diese Dateien werden NUR zur Information f√ºr Claude verwendet, nicht ver√∂ffentlicht</small>
                        </div>
                        <div class="uploaded-images" id="uploadedInfo"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">Mit Claude generieren</button>
                </form>
            </div>

            <!-- Right: Preview -->
            <div class="panel">
                <h2>Vorschau</h2>
                <div id="previewArea" class="preview-area">
                    <div class="preview-placeholder">
                        <p>Artikel-Vorschau erscheint hier nach dem Generieren</p>
                    </div>
                </div>

                <!-- Image upload after generation -->
                <div id="postGenerationImageUpload" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #eee;">
                    <div class="form-group">
                        <label>Bilder zum Artikel hinzuf√ºgen</label>
                        <div class="image-upload" id="postImageUpload">
                            <input type="file" id="postImageInput" accept="image/*" multiple style="display: none;">
                            <p>Klicken zum Hochladen oder Drag & Drop</p>
                            <small>JPG, PNG, GIF, WebP (max 5MB pro Bild)</small>
                        </div>
                        <div class="uploaded-images" id="postUploadedImages"></div>
                    </div>
                </div>

                <div class="action-buttons" id="actionButtons" style="display: none;">
                    <button class="btn btn-secondary" onclick="regenerateArticle()">Neu generieren</button>
                    <button class="btn btn-success" onclick="saveDraft()">Als Draft speichern</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDraft = null;
        let uploadedImages = [];
        let uploadedInfoFiles = [];

        // Auth Check
        const sessionToken = sessionStorage.getItem('sessionToken');
        if (!sessionToken) {
            window.location.href = 'admin.html';
        }

        // Logout
        function logout() {
            sessionStorage.clear();
            window.location.href = 'admin.html';
        }

        // Check if editing existing draft
        const urlParams = new URLSearchParams(window.location.search);
        const editDraftId = urlParams.get('edit');
        let currentEditingDraftId = null;

        // Load draft for editing if ID provided
        if (editDraftId) {
            loadDraftForEditing(editDraftId);
        }

        async function loadDraftForEditing(draftId) {
            try {
                const response = await fetch('/api/get-drafts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken })
                });

                const result = await response.json();
                if (response.ok) {
                    const draft = result.drafts.find(d => d.id === draftId);
                    if (draft) {
                        currentEditingDraftId = draftId;

                        // Fill form fields
                        document.getElementById('title').value = draft.title || '';
                        document.getElementById('category').value = draft.category || 'politik';
                        document.getElementById('style').value = draft.style || 'satirisch';
                        document.getElementById('content').value = draft.content || '';

                        // Update header to show we're editing
                        document.querySelector('.header h1').textContent = 'Artikel bearbeiten';

                        // Show preview if available
                        if (draft.html) {
                            currentDraft = draft;
                            const previewArea = document.getElementById('previewArea');
                            const actionButtons = document.getElementById('actionButtons');

                            previewArea.innerHTML = draft.html;
                            previewArea.classList.add('has-content');
                            actionButtons.style.display = 'flex';

                            // Show post-generation image upload when editing
                            document.getElementById('postGenerationImageUpload').style.display = 'block';
                        }

                        // Load images if available
                        if (draft.images && draft.images.length > 0) {
                            uploadedImages = draft.images;
                            draft.images.forEach(url => displayUploadedImage(url));
                        }
                    } else {
                        alert('Draft nicht gefunden');
                        window.location.href = 'my-articles.html';
                    }
                } else {
                    alert('Fehler beim Laden: ' + result.error);
                }
            } catch (error) {
                alert('Fehler beim Laden: ' + error.message);
            }
        }

        // Info Upload (PDFs, docs, etc.)
        const infoUpload = document.getElementById('infoUpload');
        const infoInput = document.getElementById('infoInput');
        const uploadedInfoDiv = document.getElementById('uploadedInfo');

        infoUpload.addEventListener('click', () => infoInput.click());

        infoInput.addEventListener('change', async function(e) {
            const files = e.target.files;
            for (let file of files) {
                await uploadInfoFile(file);
            }
        });

        async function uploadInfoFile(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    // For PDFs and docs, we'll just store reference for now
                    // Later can add OCR or text extraction
                    uploadedInfoFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });

                    displayUploadedInfoFile(file.name, file.type);
                } catch (error) {
                    alert('Fehler beim Hochladen: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        function displayUploadedInfoFile(name, type) {
            const div = document.createElement('div');
            div.className = 'uploaded-image';
            const icon = type.includes('pdf') ? 'üìÑ' : type.includes('image') ? 'üñºÔ∏è' : 'üìù';
            div.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; padding: 1rem; font-size: 2rem;">
                    ${icon}
                </div>
                <button class="image-remove" onclick="removeInfoFile('${name}')">√ó</button>
                <div style="position: absolute; bottom: 5px; left: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem; font-size: 0.7rem; text-align: center; border-radius: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</div>
            `;
            uploadedInfoDiv.appendChild(div);
        }

        function removeInfoFile(name) {
            uploadedInfoFiles = uploadedInfoFiles.filter(f => f.name !== name);
            const items = uploadedInfoDiv.querySelectorAll('.uploaded-image');
            items.forEach(item => {
                if (item.textContent.includes(name)) {
                    item.remove();
                }
            });
        }

        // Post-Generation Image Upload (main image upload - only after article generation)
        const postImageUpload = document.getElementById('postImageUpload');
        const postImageInput = document.getElementById('postImageInput');
        const postUploadedImagesDiv = document.getElementById('postUploadedImages');

        postImageUpload.addEventListener('click', () => postImageInput.click());

        postImageInput.addEventListener('change', async function(e) {
            const files = e.target.files;
            for (let file of files) {
                await uploadPostImage(file);
            }
        });

        async function uploadPostImage(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionToken: sessionToken,
                            imageData: e.target.result,
                            fileName: file.name,
                            articleSlug: document.getElementById('title').value
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        uploadedImages.push(result.url);
                        displayPostUploadedImage(result.url);

                        // Update currentDraft images
                        if (currentDraft) {
                            currentDraft.images = uploadedImages;
                        }
                    } else {
                        alert('Fehler beim Hochladen: ' + result.error);
                    }
                } catch (error) {
                    alert('Fehler beim Hochladen: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }

        function displayPostUploadedImage(url) {
            const div = document.createElement('div');
            div.className = 'uploaded-image';
            div.innerHTML = `
                <img src="${url}" alt="Uploaded">
                <button class="image-remove" onclick="removePostImage('${url}')">√ó</button>
            `;
            postUploadedImagesDiv.appendChild(div);
        }

        function removePostImage(url) {
            uploadedImages = uploadedImages.filter(img => img !== url);
            const imgs = postUploadedImagesDiv.querySelectorAll('.uploaded-image');
            imgs.forEach(img => {
                if (img.querySelector('img').src === url) {
                    img.remove();
                }
            });

            // Update currentDraft images
            if (currentDraft) {
                currentDraft.images = uploadedImages;
            }
        }

        // Form Submit - Generate Article
        document.getElementById('articleForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const previewArea = document.getElementById('previewArea');
            const actionButtons = document.getElementById('actionButtons');
            const statusMessage = document.getElementById('statusMessage');

            // Show loading
            previewArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>Claude generiert Artikel...</p></div>';
            previewArea.classList.remove('has-content');
            actionButtons.style.display = 'none';
            statusMessage.style.display = 'none';

            const formData = new FormData(this);

            // Add info files to content description
            let contentWithInfo = formData.get('content');
            if (uploadedInfoFiles.length > 0) {
                contentWithInfo += '\n\nHINTERGRUNDINFORMATIONEN:\n';
                contentWithInfo += uploadedInfoFiles.map(f => `- Datei: ${f.name} (${f.type})`).join('\n');
                contentWithInfo += '\n\nDiese Dateien enthalten zus√§tzliche Informationen f√ºr den Artikel. Nutze relevante Details daraus.';
            }

            const payload = {
                sessionToken: sessionToken,
                title: formData.get('title'),
                category: formData.get('category'),
                style: formData.get('style'),
                content: contentWithInfo,
                author: sessionStorage.getItem('username'),
                infoFiles: uploadedInfoFiles,
                images: uploadedImages
            };

            try {
                const response = await fetch('/api/create-article', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server-Fehler (${response.status}): ${text.substring(0, 200)}`);
                }

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'Unbekannter Fehler');
                }

                // Store current draft
                currentDraft = {
                    title: payload.title,
                    category: payload.category,
                    style: payload.style,
                    content: payload.content,
                    html: result.html,
                    fileName: result.fileName,
                    images: uploadedImages
                };

                // Show preview
                previewArea.innerHTML = result.html;
                previewArea.classList.add('has-content');
                actionButtons.style.display = 'flex';

                // Show post-generation image upload
                document.getElementById('postGenerationImageUpload').style.display = 'block';

                statusMessage.className = 'status-message status-success';
                statusMessage.textContent = '‚úÖ Artikel erfolgreich generiert!';
                statusMessage.style.display = 'block';

            } catch (error) {
                previewArea.innerHTML = `<div class="preview-placeholder"><p style="color: red;">‚ùå Fehler: ${error.message}</p></div>`;
                statusMessage.className = 'status-message status-error';
                statusMessage.textContent = '‚ùå Fehler: ' + error.message;
                statusMessage.style.display = 'block';
            }
        });

        // Regenerate Article
        async function regenerateArticle() {
            const changes = prompt('Was soll anders sein? (z.B. "lustiger", "weniger √ºbertrieben", "mehr Details √ºber...")');
            if (!changes) return;

            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>Claude generiert neu...</p></div>';

            const payload = {
                sessionToken: sessionToken,
                title: currentDraft.title,
                category: currentDraft.category,
                style: currentDraft.style,
                content: currentDraft.content + '\n\n√ÑNDERUNGSW√úNSCHE: ' + changes,
                author: sessionStorage.getItem('username')
            };

            try {
                const response = await fetch('/api/create-article', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (response.ok) {
                    currentDraft.html = result.html;
                    previewArea.innerHTML = result.html;
                } else {
                    alert('Fehler: ' + result.error);
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        // Save Draft
        async function saveDraft() {
            if (!currentDraft) {
                alert('Kein Artikel zum Speichern vorhanden');
                return;
            }

            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = 'Speichere...';
            statusMessage.className = 'status-message status-success';
            statusMessage.style.display = 'block';

            try {
                // If editing, include the draft ID to update it
                const draftPayload = currentEditingDraftId
                    ? { ...currentDraft, id: currentEditingDraftId }
                    : currentDraft;

                const response = await fetch('/api/save-draft', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionToken: sessionToken,
                        draft: draftPayload
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    statusMessage.textContent = '‚úÖ Draft gespeichert! Du findest ihn unter "Meine Artikel"';
                    setTimeout(() => {
                        window.location.href = 'my-articles.html';
                    }, 1500);
                } else {
                    throw new Error(result.error + (result.details ? '\n\nDetails: ' + result.details : '') + (result.stack ? '\n\nStack: ' + result.stack : ''));
                }
            } catch (error) {
                statusMessage.className = 'status-message status-error';
                statusMessage.innerHTML = '<pre style="white-space: pre-wrap; text-align: left; font-size: 0.85rem;">‚ùå Fehler: ' + error.message + '</pre>';
                console.error('Full error:', error);
            }
        }

        // Check if user is admin and add admin link
        async function checkAdminRole() {
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken })
                });

                const result = await response.json();
                if (result.valid && result.role === 'admin') {
                    const navLinks = document.getElementById('navLinks');
                    const adminLink = document.createElement('a');
                    adminLink.href = 'admin-users.html';
                    adminLink.textContent = 'üë• Benutzerverwaltung';
                    // Insert before logout link
                    navLinks.insertBefore(adminLink, navLinks.lastElementChild);
                }
            } catch (error) {
                console.error('Failed to check admin role:', error);
            }
        }

        // Initialize admin link check
        checkAdminRole();
    </script>
</body>
</html>
