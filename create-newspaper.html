<!DOCTYPE html>
<html lang="de-CH">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeitungs-Editor - Fl√§sch Info</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: white;
        }

        .header-logo img {
            height: 50px;
            width: auto;
        }

        .header-logo h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .user-greeting {
            color: white;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            font-weight: 600;
            display: none;
        }

        .user-greeting.show {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .steps {
            display: flex;
            gap: 2rem;
            margin-bottom: 3rem;
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #ddd;
            position: relative;
        }

        .step.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .step.completed {
            border-color: #28a745;
            background: #f0fff4;
        }

        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            background: #ddd;
            border-radius: 50%;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-bottom: 1.5rem;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .article-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            cursor: grab;
            transition: all 0.3s;
            position: relative;
        }

        .article-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .article-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .article-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .article-card.drag-over {
            border-color: #667eea;
            border-style: dashed;
            background: #f0f4ff;
        }

        .article-checkbox {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .article-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .article-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            padding-right: 30px;
        }

        .article-meta {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .article-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .category-politik { background: #e74c3c; color: white; }
        .category-wirtschaft { background: #f39c12; color: white; }
        .category-kurioses { background: #9b59b6; color: white; }
        .category-gesellschaft { background: #3498db; color: white; }
        .category-kirche { background: #27ae60; color: white; }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .cover-preview {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin-top: 1.5rem;
            background: #fafafa;
        }

        .cover-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .selected-articles {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .selected-articles h3 {
            margin-bottom: 1rem;
            color: #667eea;
        }

        .selected-article-item {
            background: white;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1.5rem;
        }

        .preview-iframe {
            width: 100%;
            min-height: 800px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="header-logo">
                <img src="logo.png" alt="Fl√§sch Info Logo">
                <h1>üì∞ Zeitungs-Editor</h1>
            </a>
            <div class="nav-links" id="navLinks">
                <a href="my-articles.html">Meine Artikel</a>
                <span class="user-greeting" id="userGreeting"></span>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Progress Steps -->
        <div class="steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-title">Artikel ausw√§hlen</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-title">Titelseite gestalten</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-title">Vorschau & Generieren</div>
            </div>
        </div>

        <!-- Step 1: Article Selection -->
        <div class="section active" id="section1">
            <h2>üìã Schritt 1: Artikel f√ºr die Zeitung ausw√§hlen</h2>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Tipp:</strong> W√§hle 4-8 Artikel aus. Der erste ausgew√§hlte Artikel wird die Hauptstory auf der Titelseite.
            </div>

            <div class="selected-articles" id="selectedArticlesSummary" style="display: none;">
                <h3>Ausgew√§hlte Artikel (<span id="selectedCount">0</span>)</h3>
                <div id="selectedArticlesList"></div>
            </div>

            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Lade ver√∂ffentlichte Artikel...</p>
            </div>

            <div class="articles-grid" id="articlesGrid"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="goToStep(2)" id="nextToStep2">
                    Weiter zur Titelseite ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Cover Configuration -->
        <div class="section" id="section2">
            <h2>üé® Schritt 2: Titelseite gestalten</h2>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Info:</strong> Die Titelseite ist die rechte Au√üenseite des gefalteten A3-Blatts.
            </div>

            <div class="form-group">
                <label for="newspaperTitle">Zeitungstitel</label>
                <input type="text" id="newspaperTitle" placeholder="z.B. Fl√§sch Info" value="Fl√§sch Info">
            </div>

            <div class="form-group">
                <label for="issueNumber">Ausgabe Nummer</label>
                <input type="text" id="issueNumber" placeholder="z.B. 1" value="1">
            </div>

            <div class="form-group">
                <label for="issueDate">Ausgabedatum</label>
                <input type="text" id="issueDate" placeholder="z.B. Januar 2025">
            </div>

            <div class="form-group">
                <label for="mainHeadline">Hauptschlagzeile (optional - sonst wird Titel vom ersten Artikel verwendet)</label>
                <input type="text" id="mainHeadline" placeholder="z.B. Sensationelle Enth√ºllungen aus Fl√§sch!">
            </div>

            <div class="form-group">
                <label for="subtitle">Untertitel / Teaser</label>
                <textarea id="subtitle" placeholder="z.B. In dieser Ausgabe: Skandale, Kurioses und mehr..."></textarea>
            </div>

            <div class="form-group">
                <label for="coverImageUpload">Titelbild (optional)</label>
                <input type="file" id="coverImageUpload" accept="image/*" onchange="handleCoverImageUpload(event)" style="margin-bottom: 1rem;">
                <div class="cover-preview" id="coverPreview">
                    <p>üì∑ Kein Titelbild hochgeladen.</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Zur√ºck</button>
                <button class="btn btn-primary" onclick="goToStep(3)">Zur Vorschau ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: Preview & Generate -->
        <div class="section" id="section3">
            <h2>üëÅÔ∏è Schritt 3: Vorschau & PDF generieren</h2>

            <div class="info-box">
                <strong>üìÑ Layout:</strong> A3-Format zum Falzen - Seite 1 (Titelseite), Seiten 2-3 (Innen), Seite 4 (R√ºckseite)
            </div>

            <div id="previewLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Erstelle Vorschau...</p>
            </div>

            <div id="previewContent" style="display: none;">
                <iframe id="previewIframe" class="preview-iframe"></iframe>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Zur√ºck</button>
                <button id="downloadBtn" class="btn btn-success" onclick="generatePDF()">üì• PDF Herunterladen</button>
            </div>
        </div>
    </div>

    <script>
        const sessionToken = localStorage.getItem('sessionToken');
        if (!sessionToken) {
            window.location.href = 'admin.html';
        }

        let selectedArticles = [];
        let allArticles = [];
        let currentStep = 1;
        let coverImageData = null; // Store uploaded cover image

        // Logout
        function logout() {
            const cookieConsent = localStorage.getItem('flaesch_cookie_consent');
            localStorage.clear();
            if (cookieConsent) {
                localStorage.setItem('flaesch_cookie_consent', cookieConsent);
            }
            window.location.href = 'admin.html';
        }

        // Load published articles
        async function loadPublishedArticles() {
            try {
                const response = await fetch('articles.json');
                if (!response.ok) throw new Error('Failed to load articles');

                allArticles = await response.json();

                document.getElementById('loadingIndicator').style.display = 'none';
                renderArticles();
            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('loadingIndicator').innerHTML = '<p style="color: red;">Fehler beim Laden der Artikel</p>';
            }
        }

        function renderArticles() {
            const grid = document.getElementById('articlesGrid');
            grid.innerHTML = allArticles.map((article, index) => `
                <div class="article-card ${selectedArticles.includes(article.fileName) ? 'selected' : ''}"
                     onclick="toggleArticle('${article.fileName}')">
                    <input type="checkbox" class="article-checkbox"
                           ${selectedArticles.includes(article.fileName) ? 'checked' : ''}
                           onclick="event.stopPropagation(); toggleArticle('${article.fileName}')">
                    ${article.image ? `<img src="${article.image}" class="article-image">` : '<div class="article-image"></div>'}
                    <div class="article-title">${article.title}</div>
                    <div class="article-meta">${new Date(article.date).toLocaleDateString('de-CH')}</div>
                    <span class="article-category category-${article.category}">${getCategoryLabel(article.category)}</span>
                </div>
            `).join('');
        }

        function toggleArticle(fileName) {
            if (selectedArticles.includes(fileName)) {
                selectedArticles = selectedArticles.filter(f => f !== fileName);
            } else {
                selectedArticles.push(fileName);
            }
            renderArticles();
            updateSelectedSummary();
        }

        function updateSelectedSummary() {
            const summary = document.getElementById('selectedArticlesSummary');
            const count = document.getElementById('selectedCount');
            const list = document.getElementById('selectedArticlesList');

            count.textContent = selectedArticles.length;

            if (selectedArticles.length > 0) {
                summary.style.display = 'block';
                list.innerHTML = selectedArticles.map((fileName, index) => {
                    const article = allArticles.find(a => a.fileName === fileName);
                    return `
                        <div class="selected-article-item"
                             draggable="true"
                             data-filename="${fileName}"
                             ondragstart="handleDragStart(event)"
                             ondragend="handleDragEnd(event)"
                             ondragover="handleDragOver(event)"
                             ondrop="handleDrop(event)"
                             style="cursor: move;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #999; font-size: 1.2rem;">‚ò∞</span>
                                <div>
                                    <strong>${index + 1}.</strong> ${article.title}
                                    <small style="color: #999;"> (${getCategoryLabel(article.category)})</small>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); toggleArticle('${fileName}')" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer;">Entfernen</button>
                        </div>
                    `;
                }).join('');
            } else {
                summary.style.display = 'none';
            }
        }

        function getCategoryLabel(category) {
            const labels = {
                'politik': 'Politik',
                'wirtschaft': 'Wirtschaft',
                'kurioses': 'Kurioses',
                'gesellschaft': 'Gesellschaft',
                'kirche': 'Kirche'
            };
            return labels[category] || category;
        }

        // Drag & Drop handlers
        let draggedElement = null;

        function handleDragStart(event) {
            draggedElement = event.currentTarget;
            event.currentTarget.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.currentTarget.innerHTML);
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.selected-article-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDrop(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            event.preventDefault();

            event.currentTarget.classList.remove('drag-over');

            if (draggedElement !== event.currentTarget) {
                const draggedFileName = draggedElement.dataset.filename;
                const targetFileName = event.currentTarget.dataset.filename;

                const draggedIndex = selectedArticles.indexOf(draggedFileName);
                const targetIndex = selectedArticles.indexOf(targetFileName);

                if (draggedIndex >= 0 && targetIndex >= 0) {
                    // Swap articles in selectedArticles array
                    const temp = selectedArticles[draggedIndex];
                    selectedArticles[draggedIndex] = selectedArticles[targetIndex];
                    selectedArticles[targetIndex] = temp;

                    // Re-render selected list
                    updateSelectedSummary();
                }
            }

            return false;
        }

        // Cover image upload handler
        async function handleCoverImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('coverPreview');
            preview.innerHTML = '<p>‚è≥ Lade Bild hoch...</p>';

            // Check if sessionToken exists
            if (!sessionToken) {
                preview.innerHTML = '<p style="color: red;">‚ùå Nicht eingeloggt. Bitte neu anmelden.</p>';
                setTimeout(() => window.location.href = 'admin.html', 2000);
                return;
            }

            try {
                // Convert file to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const base64Data = e.target.result;

                        console.log('Uploading image...', {
                            fileName: file.name,
                            fileSize: file.size,
                            hasToken: !!sessionToken
                        });

                        const response = await fetch('/api/upload-image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                sessionToken: sessionToken,
                                imageData: base64Data,
                                fileName: file.name,
                                articleSlug: 'cover-image'
                            })
                        });

                        const result = await response.json();
                        console.log('Upload response:', { status: response.status, result });

                        if (!response.ok) {
                            if (response.status === 401) {
                                throw new Error('Session abgelaufen. Bitte neu anmelden.');
                            }
                            throw new Error(result.error || result.details || `Upload fehlgeschlagen (Status ${response.status})`);
                        }

                        if (!result.imageUrl) {
                            throw new Error('Keine Bild-URL in der Antwort erhalten');
                        }

                        coverImageData = result.imageUrl;

                        preview.innerHTML = `
                            <p><strong>‚úÖ Titelbild hochgeladen</strong></p>
                            <img src="${coverImageData}" alt="Cover Image" style="max-width: 100%; max-height: 300px; margin-top: 1rem; border-radius: 8px;">
                            <button onclick="removeCoverImage()" style="margin-top: 1rem; background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Entfernen</button>
                        `;
                    } catch (error) {
                        console.error('Error uploading cover image:', error);
                        preview.innerHTML = `<p style="color: red;">‚ùå Fehler beim Hochladen: ${error.message}</p>`;
                        coverImageData = null;

                        // Redirect to login if session expired
                        if (error.message.includes('Session abgelaufen') || error.message.includes('anmelden')) {
                            setTimeout(() => window.location.href = 'admin.html', 2000);
                        }
                    }
                };
                reader.onerror = function() {
                    preview.innerHTML = '<p style="color: red;">‚ùå Fehler beim Lesen der Datei</p>';
                    coverImageData = null;
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error preparing image upload:', error);
                preview.innerHTML = `<p style="color: red;">‚ùå Fehler: ${error.message}</p>`;
                coverImageData = null;
            }
        }

        function removeCoverImage() {
            coverImageData = null;
            document.getElementById('coverImageUpload').value = '';
            document.getElementById('coverPreview').innerHTML = '<p>üì∑ Kein Titelbild hochgeladen.</p>';
        }

        function goToStep(step) {
            if (step === 2 && selectedArticles.length === 0) {
                alert('Bitte w√§hle mindestens einen Artikel aus!');
                return;
            }

            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                const sectionEl = document.getElementById(`section${i}`);

                stepEl.classList.remove('active', 'completed');
                sectionEl.classList.remove('active');

                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                    sectionEl.classList.add('active');
                }
            }

            currentStep = step;

            // Special handling for each step
            if (step === 2) {
                updateCoverPreview();
            } else if (step === 3) {
                generatePreview();
            }
        }

        function updateCoverPreview() {
            if (selectedArticles.length > 0) {
                const firstArticle = allArticles.find(a => a.fileName === selectedArticles[0]);
                const preview = document.getElementById('coverPreview');

                if (firstArticle.image) {
                    preview.innerHTML = `
                        <p><strong>Titelbild:</strong></p>
                        <img src="${firstArticle.image}" alt="${firstArticle.title}">
                        <p style="margin-top: 1rem;"><small>${firstArticle.title}</small></p>
                    `;
                }
            }
        }

        async function generatePreview() {
            document.getElementById('previewLoading').style.display = 'block';
            document.getElementById('previewContent').style.display = 'none';

            // Build newspaper data
            const newspaperData = {
                title: document.getElementById('newspaperTitle').value,
                issueNumber: document.getElementById('issueNumber').value,
                issueDate: document.getElementById('issueDate').value || new Date().toLocaleDateString('de-CH', { year: 'numeric', month: 'long' }),
                mainHeadline: document.getElementById('mainHeadline').value,
                subtitle: document.getElementById('subtitle').value,
                coverImage: coverImageData,
                articles: selectedArticles.map(fileName => allArticles.find(a => a.fileName === fileName))
            };

            // Show preview
            setTimeout(() => {
                document.getElementById('previewLoading').style.display = 'none';
                document.getElementById('previewContent').style.display = 'block';

                const iframe = document.getElementById('previewIframe');
                iframe.srcdoc = generatePreviewHTML(newspaperData);
            }, 500);
        }

        function generatePreviewHTML(data) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body {
                            font-family: Georgia, 'Times New Roman', serif;
                            margin: 0;
                            padding: 20px;
                            background: white;
                        }
                        .newspaper-title {
                            text-align: center;
                            font-size: 3rem;
                            font-weight: bold;
                            border-top: 4px solid black;
                            border-bottom: 4px solid black;
                            padding: 1rem 0;
                            margin-bottom: 0.5rem;
                        }
                        .issue-info {
                            text-align: center;
                            font-style: italic;
                            margin-bottom: 2rem;
                        }
                        .main-headline {
                            font-size: 2.5rem;
                            font-weight: bold;
                            text-align: center;
                            margin: 2rem 0 1rem;
                            line-height: 1.2;
                        }
                        .subtitle {
                            text-align: center;
                            font-style: italic;
                            font-size: 1.2rem;
                            margin-bottom: 2rem;
                        }
                        .cover-image {
                            width: 100%;
                            max-height: 400px;
                            object-fit: cover;
                            margin: 1rem 0;
                            border: 2px solid #333;
                        }
                        .article-preview {
                            border-top: 2px solid #ccc;
                            padding: 1rem 0;
                            margin-top: 1rem;
                        }
                        .article-preview h3 {
                            font-size: 1.5rem;
                            margin-bottom: 0.5rem;
                        }
                        .article-preview p {
                            font-size: 1rem;
                            line-height: 1.6;
                        }
                        .article-category {
                            display: inline-block;
                            padding: 0.25rem 0.75rem;
                            background: #333;
                            color: white;
                            font-size: 0.8rem;
                            margin-bottom: 0.5rem;
                            text-transform: uppercase;
                        }
                        .watermark {
                            text-align: center;
                            color: #999;
                            margin-top: 2rem;
                            padding-top: 1rem;
                            border-top: 1px solid #ccc;
                        }
                    </style>
                </head>
                <body>
                    <div class="newspaper-title">${data.title}</div>
                    <div class="issue-info">Ausgabe ${data.issueNumber} ‚Ä¢ ${data.issueDate}</div>

                    ${data.mainHeadline ? `<div class="main-headline">${data.mainHeadline}</div>` : ''}
                    ${data.subtitle ? `<div class="subtitle">${data.subtitle}</div>` : ''}

                    ${data.coverImage ? `<img src="${data.coverImage}" class="cover-image" alt="Titelbild">` : ''}

                    ${data.articles.map((article, index) => `
                        <div class="article-preview">
                            <span class="article-category">${article.category}</span>
                            <h3>${index + 1}. ${article.title}</h3>
                            ${article.subtitle ? `<p style="font-style: italic; color: #666;">${article.subtitle}</p>` : ''}
                        </div>
                    `).join('')}

                    <div class="watermark">
                        <p><strong>üìÑ VORSCHAU</strong></p>
                        <p>Die finale PDF-Version enth√§lt das vollst√§ndige 4-seitige A3-Layout mit allen Artikeln</p>
                    </div>
                </body>
                </html>
            `;
        }

        async function generatePDF() {
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.textContent;

            // Check if sessionToken exists
            if (!sessionToken) {
                alert('‚ùå Nicht eingeloggt. Bitte neu anmelden.');
                setTimeout(() => window.location.href = 'admin.html', 1000);
                return;
            }

            downloadBtn.textContent = '‚è≥ PDF wird generiert...';
            downloadBtn.disabled = true;

            // Prepare data for PDF generation
            const newspaperData = {
                sessionToken: sessionToken,
                title: document.getElementById('newspaperTitle').value,
                issueNumber: document.getElementById('issueNumber').value,
                issueDate: document.getElementById('issueDate').value || new Date().toLocaleDateString('de-CH', { year: 'numeric', month: 'long' }),
                mainHeadline: document.getElementById('mainHeadline').value,
                subtitle: document.getElementById('subtitle').value,
                coverImage: coverImageData,
                articleFileNames: selectedArticles
            };

            console.log('Generating PDF...', {
                hasToken: !!sessionToken,
                articleCount: selectedArticles.length,
                hasCoverImage: !!coverImageData
            });

            try {
                const response = await fetch('/api/generate-newspaper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newspaperData)
                });

                console.log('PDF response:', { status: response.status, ok: response.ok });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `flaesch-info-ausgabe-${newspaperData.issueNumber}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    downloadBtn.textContent = '‚úÖ PDF heruntergeladen!';
                    setTimeout(() => {
                        downloadBtn.textContent = originalText;
                        downloadBtn.disabled = false;
                    }, 3000);
                } else {
                    let errorMessage = 'Unbekannter Fehler';
                    try {
                        const error = await response.json();
                        errorMessage = error.error || error.details || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }

                    if (response.status === 401) {
                        alert('‚ùå Session abgelaufen. Bitte neu anmelden.');
                        setTimeout(() => window.location.href = 'admin.html', 2000);
                    } else {
                        alert('‚ùå Fehler: ' + errorMessage);
                    }

                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Fehler beim Generieren des PDFs: ' + error.message);
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        }

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionToken })
                });
                const result = await response.json();
                if (result.valid && result.displayName) {
                    const greetingElement = document.getElementById('userGreeting');
                    if (greetingElement) {
                        greetingElement.textContent = `Hallo ${result.displayName}`;
                        greetingElement.classList.add('show');
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Initialize
        loadUserInfo();
        loadPublishedArticles();
    </script>
</body>
</html>
